pipeline {
  agent any;



  stages {
    stage("GIT") {
      steps {
        sh 'git checkout karoui'
        sh 'git pull origin karoui'
      }
    }
    //
stage("MAVEN BUILD") {
      steps {
       dir('gestion-station-ski') {
        sh 'mvn clean install -Dmaven.test.skip=true'
      }
    }
    }




 stage("SONARQUBE") {
      steps {
      dir('gestion-station-ski') {
       sh "mvn sonar:sonar -Dsonar.login=admin -Dsonar.password=azerty"
      }}
    }

 stage("MOCKITO") {
       steps {
       dir('gestion-station-ski') {
         sh "mvn test -Dtest=service.CourseServiceImpMock"
       } }
     }

     stage("build docker image") {
                         steps {
                         dir('gestion-station-ski'){
                           sh 'docker build -t mazizkaroui/aziz-karoui-5sae4-gestion-station-ski:latest .'
                         }
                       }
                       }

          stage('docker push'){
                        steps{
                              dir('gestion-station-ski') {

                            script{
                                sh 'docker login -u "mazizkaroui" -p "azerty123" docker.io'
                                sh 'docker push mazizkaroui/aziz-karoui-5sae4-gestion-station-ski:latest'
                            }
                        }
                    }}




    stage('docker compose') {
                  steps{
                        dir('gestion-station-ski') {
                      sh 'docker compose down'
                      sh 'docker compose up -d'
                  }}
              }

     stage('MVN NEXUS')
                {
                steps {
                dir('gestion-station-ski'){
                sh 'mvn  deploy -DskipTests  '
                }}
                }
}

post {
        success {
            emailext(
                subject: "Jenkins Pipeline: Success",
                body: "Your Jenkins pipeline has successfully completed.",
                to: 'mohamedaziz.karoui@esprit.tn'
            )
        }
        failure {
            emailext(
                subject: "Jenkins Pipeline: Failure",
                body: "Your Jenkins pipeline has failed. Please check the build logs for more details.",
                to: 'mohamedaziz.karoui@esprit.tn'
            )
        }
    }

}
